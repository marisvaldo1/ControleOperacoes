<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Investimentos - Opcoes</title>
    <link rel="stylesheet" href="../css/style.css?v=1.0.7">
    <link rel="stylesheet" href="../css/opcoes.css?v=1.0.7">
    <link rel="stylesheet" href="../css/modal-detalhes.css?v=1.0.7">
    <link rel="stylesheet" href="../css/detalhe-opcoes.css?v=1.0.7">
</head>

<body data-bs-theme="dark">
    <div class="page-wrapper">
        <div class="page-body">
            <div class="container-fluid">
                <div class="page-header d-print-none mb-4">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <h2 class="page-title">Controle de Investimentos - Opcoes</h2>
                            <div class="text-muted">Opcoes de Acoes</div>
                        </div>
                        <div class="col-auto ms-auto d-flex align-items-center gap-3">
                            <button class="btn btn-info me-2" id="btnSimularOperacao">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M2 12h10"/><path d="M9 4v16"/><path d="M3 9l3 3-3 3"/><path d="M14 9l3 3-3 3"/></svg>
                                Simular
                            </button>
                            <button class="btn btn-primary" id="btnNovaOperacao">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M12 5v14M5 12h14"/></svg>
                                Nova Operacao
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row row-deck row-cards mb-4">
                    <div class="col-sm-6 col-lg-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="subheader">Total Operacoes</div>
                                    <div class="ms-auto">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                    </div>
                                </div>
                                <div class="h1 mb-0" id="cardTotalOps">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="card card-clickable" id="cardSaldoCorretoraCard" role="button" tabindex="0" title="Ver histórico de operações">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="subheader">Saldo na Corretora</div>
                                    <div class="ms-auto text-primary">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4h-6"/><line x1="12" y1="2" x2="12" y2="22"/></svg>
                                    </div>
                                </div>
                                <div class="h1 mb-0 text-primary" id="cardSaldoCorretora">R$ 0,00</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="subheader">Resultado Total</div>
                                    <div class="ms-auto text-success">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                                    </div>
                                </div>
                                <div class="h1 mb-0 text-success" id="cardResultadoTotal">R$ 0,00</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="subheader">Resultado Medio</div>
                                    <div class="ms-auto text-success">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
                                    </div>
                                </div>
                                <div class="h1 mb-0 text-success" id="cardResultadoMedio">0.00%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" data-bs-toggle="tabs">
                            <li class="nav-item">
                                <a href="#tab-mes-atual" class="nav-link active" data-bs-toggle="tab">Mes Atual</a>
                            </li>
                            <li class="nav-item">
                                <a href="#tab-historico" class="nav-link" data-bs-toggle="tab">Historico</a>
                            </li>
                            <li class="nav-item">
                                <a href="#tab-anual" class="nav-link" data-bs-toggle="tab">Anual</a>
                            </li>
                            <li class="nav-item">
                                <a href="#tab-configuracoes" class="nav-link" data-bs-toggle="tab">Configurações</a>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content">
                            <div class="tab-pane active show" id="tab-mes-atual">
                                <div class="row mb-4" id="mesAtualHeader"></div>
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title" id="mesAtualTitle">Operacoes</h3>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-vcenter card-table" id="tableMesAtual">
                                            <thead>
                                                <tr>
                                                    <th>Ativo Base</th>
                                                    <th>Preco Atual</th>
                                                    <th>Preco Entrada</th>
                                                    <th>Ativo</th>
                                                    <th>Tipo</th>
                                                    <th>Quantidade</th>
                                                    <th>Strike</th>
                                                    <th>Premio</th>
                                                    <th>Resultado</th>
                                                    <th>Vencimento</th>
                                                    <th title="Dias úteis / Dias corridos">Dias <span title="Dias úteis / Dias corridos">❓</span></th>
                                                    <th>Exercicio</th>
                                                    <th>Status</th>
                                                    <th>Acoes</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane" id="tab-historico">
                                <h4 class="mb-3">Historico Mensal</h4>
                                <div id="historicoContainer"></div>
                                <div class="card mt-4">
                                    <div class="card-header">
                                        <h3 class="card-title">Todas as Operacoes</h3>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-vcenter card-table" id="tableHistorico">
                                            <thead>
                                                <tr>
                                                    <th>Ativo Base</th>
                                                    <th>Preco Atual</th>
                                                    <th>Preco Entrada</th>
                                                    <th>Ativo</th>
                                                    <th>Tipo</th>
                                                    <th>Quantidade</th>
                                                    <th>Strike</th>
                                                    <th>Premio</th>
                                                    <th>Resultado</th>
                                                    <th>Vencimento</th>
                                                    <th title="Dias úteis / Dias corridos">Dias <span title="Dias úteis / Dias corridos">❓</span></th>
                                                    <th>Exercicio</th>
                                                    <th>Status</th>
                                                    <th>Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane" id="tab-anual">
                                <div class="row mb-4" id="anualHeader"></div>
                                <div class="card">
                                    <div class="card-body">
                                        <canvas id="chartAnual" height="300"></canvas>
                                    </div>
                                </div>
                                <div id="anualTabelaContainer"></div>
                            </div>
                            <div class="tab-pane" id="tab-configuracoes">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="card">
                                            <div class="card-header">
                                                <h3 class="card-title">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
                                                    Configurações de IA
                                                </h3>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Selecione a IA para análises</label>
                                                    <select class="form-select" id="selectIA">
                                                        <option value="">Carregando...</option>
                                                    </select>
                                                    <div class="form-text">Escolha qual inteligência artificial será usada para analisar suas operações.</div>
                                                </div>
                                                <div class="mb-3">
                                                    <button type="button" class="btn btn-primary" id="btnSalvarConfigIA">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                                                        Salvar Configuração
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary ms-2" id="btnTestarIA">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                                                        Testar Conexão
                                                    </button>
                                                </div>
                                                <div id="iaStatus" class="alert alert-info d-none"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header">
                                                <h3 class="card-title">Informações</h3>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <h4 class="text-muted mb-2">IAs Disponíveis:</h4>
                                                    <ul class="list-unstyled">
                                                        <li class="mb-2">
                                                            <span class="badge bg-blue me-2">OpenAI</span>
                                                            <small class="text-muted">GPT-3.5, GPT-4</small>
                                                        </li>
                                                        <li class="mb-2">
                                                            <span class="badge bg-green me-2">DeepSeek</span>
                                                            <small class="text-muted">Modelo otimizado</small>
                                                        </li>
                                                        <li class="mb-2">
                                                            <span class="badge bg-purple me-2">Grok</span>
                                                            <small class="text-muted">xAI - Grok-2</small>
                                                        </li>
                                                        <li class="mb-2">
                                                            <span class="badge bg-yellow me-2">Gemini</span>
                                                            <small class="text-muted">Google AI</small>
                                                        </li>
                                                        <li class="mb-2">
                                                            <span class="badge bg-cyan me-2">OpenRouter</span>
                                                            <small class="text-muted">Múltiplos modelos</small>
                                                        </li>
                                                    </ul>
                                                </div>
                                                <div class="alert alert-warning mb-0">
                                                    <strong>Nota:</strong> As opções disponíveis dependem das chaves de API configuradas no arquivo .env do backend.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nova/Editar Operação -->
    <div class="modal modal-blur fade" id="modalOperacao" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <span id="modalOperacaoTitle">Nova Operacao</span>
                        <span id="modalOperacaoAtivoInfo" class="badge bg-primary ms-2" style="display: none;"></span>
                        <span id="modalOperacaoMarketStatus" class="ms-2" style="cursor: help; font-size: 1.2rem;"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formOperacao">
                        <input type="hidden" id="operacaoId">
                        <input type="hidden" id="inputSaldoAbertura">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Ativo Base <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="text" class="form-control text-uppercase" id="inputAtivoBase" required placeholder="Ex: PETR4" style="text-transform: uppercase;">
                                    <button class="btn btn-outline-primary" type="button" id="btnBuscarOpcoes" title="Buscar opções disponíveis">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Ativo <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="text" class="form-control text-uppercase" id="inputAtivo" required placeholder="Ex: PETRM346" style="text-transform: uppercase;">
                                    <button class="btn btn-outline-secondary" type="button" id="btnAtualizarDados" title="Atualizar dados da API">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Tipo</label>
                                <select class="form-select" id="inputTipo">
                                    <option value="CALL">CALL</option>
                                    <option value="PUT">PUT</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Data Operacao</label>
                                <input type="date" class="form-control" id="inputDataOperacao">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Quantidade</label>
                                <input type="number" class="form-control" id="inputQuantidade" placeholder="100" min="100" step="100">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Preco Entrada (R$)</label>
                                <input type="text" class="form-control input-currency" id="inputPrecoEntrada" placeholder="R$ 0,00">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Cotação Atual (R$)</label>
                                <input type="text" class="form-control input-currency" id="inputPrecoAtual" placeholder="R$ 0,00">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Strike (R$)</label>
                                <input type="text" class="form-control input-currency" id="inputStrike" placeholder="R$ 0,00">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Vencimento <span class="badge bg-secondary">API</span></label>
                                <input type="date" class="form-control" id="inputVencimento">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Premio (R$)</label>
                                <input type="text" class="form-control input-currency" id="inputPremio" placeholder="R$ 0,00">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Resultado (R$) <span class="badge bg-secondary">Auto</span></label>
                                <input type="text" class="form-control input-currency" id="inputResultado" placeholder="R$ 0,00">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="inputStatus">
                                    <option value="ABERTA">ABERTA</option>
                                    <option value="FECHADA">FECHADA</option>
                                    <option value="EXERCIDA">EXERCIDA</option>
                                </select>
                            </div>
                        </div>

                        <!-- Notional Card -->
                        <div class="card mb-3 bg-dark-lt border-primary" id="cardNotional" style="display: none;">
                            <div class="card-body py-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-uppercase text-muted font-weight-bold" style="font-size: 0.9rem;">
                                        NATIONAL DA OPERAÇÃO 
                                        <span class="ms-1" id="tooltipNational" data-bs-toggle="tooltip" data-bs-placement="top" title="Quantidade de capital requerido caso seja exercido">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-secondary"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>
                                        </span>
                                    </span>
                                </div>
                                <div class="h2 mb-3" id="notionalValor">R$ 0,00</div>
                                
                                <div class="d-flex justify-content-between mb-1 small">
                                    <span>Meta <span id="metaPercentual" class="text-success ms-2">0%</span> <span class="text-success">↗</span></span>
                                    <span class="text-success" id="metaValor">R$ 0,00</span>
                                </div>
                                <div class="progress progress-sm mb-2">
                                    <div class="progress-bar bg-warning" id="notionalProgressBar" style="width: 0%" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>

                                <div class="d-flex justify-content-between mb-1 small">
                                    <span>Saldo <span id="saldoPercentual" class="text-primary ms-2">0%</span></span>
                                    <span class="text-primary" id="saldoValor">R$ 0,00</span>
                                </div>
                                <div class="progress progress-sm">
                                    <div class="progress-bar bg-info" id="saldoProgressBar" style="width: 0%" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info mb-0" id="apiInfo">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                            Digite o <strong>Ativo Base</strong> (ex: PETR4) e clique no botão de busca para carregar as opções disponíveis.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnSaveOperacao">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Selecionar Opção -->
    <div class="modal modal-blur fade" id="modalSelecionarOpcao" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document" style="max-width: 1000px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <span id="tituloModalOpcoes">Selecione uma Opção</span>
                        <span id="modalSelecaoMarketStatus" class="ms-2" style="cursor: help; font-size: 1.2rem;"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Filtros -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Filtrar por Vencimento:</label>
                            <select class="form-select" id="filtroVencimento">
                                <option value="TODOS">Todos os vencimentos</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Buscar:</label>
                            <input type="text" class="form-control text-uppercase" id="filtroBusca" placeholder="Buscar por código...">
                        </div>
                    </div>
                    
                    <!-- Info do ativo base -->
                    <div class="alert alert-primary mb-3" id="infoAtivoBase" style="display: none;">
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Ativo:</strong> <span id="infoAtivoNome">-</span>
                            </div>
                            <div class="col-md-4">
                                <strong>Cotação Atual:</strong> <span id="infoCotacaoAtual">-</span>
                            </div>
                            <div class="col-md-4">
                                <strong>Total de Opções:</strong> <span id="infoTotalOpcoes">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Loading -->
                    <div id="loadingOpcoes" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-3 text-muted">Buscando opções disponíveis...</p>
                    </div>

                    <!-- Tabela de Opções -->
                    <div class="table-responsive" id="containerTabelaOpcoes" style="display: none; max-height: 500px;">
                        <table class="table table-vcenter table-hover card-table table-striped" id="tableOpcoes">
                            <thead class="sticky-top bg-dark text-white">
                                <tr>
                                    <th colspan="4" class="text-center bg-success bg-opacity-10 text-success border-bottom-0">CALLS (Opção de Compra)</th>
                                    <th class="text-center bg-secondary bg-opacity-10 border-bottom-0"> | </th>
                                    <th colspan="4" class="text-center bg-danger bg-opacity-10 text-danger border-bottom-0">PUTS (Opção de Venda)</th>
                                </tr>
                                <tr>
                                    <!-- CALL SIDE -->
                                    <th style="width: 12%">Ativo</th>
                                    <th style="width: 10%">Prêmio</th>
                                    <th style="width: 8%">Dias <span class="text-decoration-none cursor-help" data-bs-toggle="tooltip" title="Dias para o vencimento (Corridos/Úteis)">❓</span></th>
                                    <th style="width: 8%">Delta</th>
                                    
                                    <!-- CENTER -->
                                    <th class="text-center bg-secondary bg-opacity-10 border-start border-end" style="width: 12%">Strike</th>
                                    
                                    <!-- PUT SIDE -->
                                    <th style="width: 8%">Delta</th>
                                    <th style="width: 8%">Dias <span class="text-decoration-none cursor-help" data-bs-toggle="tooltip" title="Dias para o vencimento (Corridos/Úteis)">❓</span></th>
                                    <th style="width: 10%">Prêmio</th>
                                    <th style="width: 12%">Ativo</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyOpcoes"></tbody>
                        </table>
                    </div>

                    <!-- Sem resultados -->
                    <div id="semOpcoes" class="text-center py-5" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-muted mb-3"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
                        <p class="text-muted">Nenhuma opção encontrada para este ativo.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <span class="text-muted me-auto" id="contadorOpcoes">0 opções exibidas</span>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Historico de Operacoes (Saldo) -->
    <div class="modal modal-blur fade" id="modalSaldoOperacoes" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Histórico de Resultado sobre Saldo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3 mb-3">
                        <div class="col-md-3">
                            <label class="form-label">Data Início</label>
                            <input type="date" class="form-control" id="saldoInicio">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Data Fim</label>
                            <input type="date" class="form-control" id="saldoFim">
                        </div>
                        <div class="col-md-3 align-self-end">
                            <button class="btn btn-primary w-100" id="btnFiltrarSaldo">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                                Filtrar
                            </button>
                        </div>
                    </div>

                    <div class="row row-cards mb-3" id="saldoResumo"></div>

                    <div class="row row-cards">
                        <div class="col-md-7">
                            <div class="card">
                                <div class="card-header"><h3 class="card-title">Evolução do Resultado Acumulado</h3></div>
                                <div class="card-body">
                                    <div class="chart-container" style="position: relative; height: 260px;">
                                        <canvas id="chartSaldoAcumulado"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="card">
                                <div class="card-header"><h3 class="card-title">Distribuição por Tipo</h3></div>
                                <div class="card-body">
                                    <div class="chart-container" style="position: relative; height: 260px;">
                                        <canvas id="chartSaldoTipo"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header"><h3 class="card-title">Operações Detalhadas</h3></div>
                        <div class="table-responsive">
                            <table class="table table-vcenter card-table" id="saldoTabela">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Ativo</th>
                                        <th>Tipo</th>
                                        <th>Strike</th>
                                        <th>Exercido</th>
                                        <th>Saldo Abertura</th>
                                        <th>Resultado</th>
                                        <th>%</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Simulação -->
    <div class="modal modal-blur fade" id="modalSimulacao" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <span id="modalSimulacaoTitle">Simulação de Operações</span>
                        <span id="modalSimulacaoMarketStatus" class="ms-2" style="cursor: help; font-size: 1.2rem;"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Left Column: Controls & List -->
                        <div class="col-lg-5 border-end">
                            <div class="row mb-3">
                                <div class="col-md-7">
                                    <label class="form-label">Ativo Base</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control text-uppercase" id="simAtivoBase" placeholder="Ex: PETR4">
                                        <button class="btn btn-icon btn-primary" id="btnSimBuscar">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <label class="form-label">Quantidade</label>
                                    <input type="number" class="form-control" id="simQuantidade" placeholder="100" min="100" step="100" value="100">
                                </div>
                            </div>
                            
                             <div class="mb-3">
                                <div class="row g-3">
                                    <div class="col-6">
                                        <label class="form-label mb-2 small text-muted">Tipo</label>
                                        <div class="radio-group">
                                            <label class="radio-option">
                                                <input type="radio" name="simTipoOpcao" value="CALL" checked>
                                                <span class="radio-label">CALL</span>
                                            </label>
                                            <label class="radio-option">
                                                <input type="radio" name="simTipoOpcao" value="PUT">
                                                <span class="radio-label">PUT</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label mb-2 small text-muted">Posição</label>
                                        <div class="radio-group">
                                            <label class="radio-option">
                                                <input type="radio" name="simPosicao" value="COMPRA" checked>
                                                <span class="radio-label">Compra</span>
                                            </label>
                                            <label class="radio-option">
                                                <input type="radio" name="simPosicao" value="VENDA">
                                                <span class="radio-label">Venda</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-2 g-2">
                                <div class="col-md-5">
                                    <label class="form-label mb-1 small">Vencimento</label>
                                    <select class="form-select form-select-sm" id="simVencimento"></select>
                                </div>
                                <div class="col-md-7">
                                    <label class="form-label mb-1 small">Buscar Opção</label>
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control" id="simBusca" placeholder="Filtrar...">
                                        <span class="input-group-text">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">Lista das opções do próximo vencimento</small>
                                <div class="d-flex align-items-center gap-2">
                                    <small class="text-muted" id="simUltimaAtualizacao" style="font-size: 0.7rem;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                        Atualizado: -
                                    </small>
                                    <button class="btn btn-sm btn-icon btn-secondary" id="btnRefreshSim" title="Atualizar Lista" style="width: 2rem; height: 2rem;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                                    </button>
                                </div>
                            </div>

                            <div class="card" style="height: 380px; overflow-y: auto;">
                                <div class="table-responsive">
                                    <table class="table table-vcenter table-hover card-table table-striped sticky-header">
                                        <thead class="sticky-top bg-white">
                                            <tr>
                                                <th>Ativo</th>
                                                <th>Strike</th>
                                                <th>Prêmio</th>
                                                <th>Delta</th>
                                                <th>PoP</th>
                                            </tr>
                                        </thead>
                                        <tbody id="simListaOpcoes">
                                            <!-- Options populated here -->
                                        </tbody>
                                    </table>
                                </div>
                                <div id="simLoading" class="text-center py-5" style="display: none;">
                                    <div class="spinner-border text-primary" role="status"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Simulation Details & Charts -->
                        <div class="col-lg-7 d-flex flex-column">
                            <div id="simDetailPanel" style="display:none;" class="h-100 flex-column">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h3 class="mb-0">Simulação</h3>
                                    <div>
                                        <button class="btn btn-info btn-sm me-2" id="btnAnaliseTecnica">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                                            Análise Técnica
                                        </button>
                                        <button class="btn btn-primary btn-sm" id="btnAnaliseIA">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
                                            Análise IA
                                        </button>
                                    </div>
                                </div>
                                <div class="card mb-3 bg-primary-lt">
                                    <div class="card-body">
                                        <div class="row align-items-center">
                                            <div class="col-md-6">
                                                <h2 class="card-title mb-0" id="simOpcaoTitle" style="font-size: 2rem;">PETRA367W5</h2>
                                            </div>
                                            <div class="col-md-6 text-end">
                                                 <div class="display-6 fw-bold text-success" id="simOpcaoCotacao" style="font-size: 2rem;">R$ 35,90</div>
                                            </div>
                                        </div>
                                        <hr class="my-3">
                                        <div class="row g-2">
                                            <div class="col-4">
                                                <div class="text-muted small">Opção</div>
                                                <div class="fw-bold text-truncate" id="simOpcaoNome" style="font-size: 0.9rem;">-</div>
                                            </div>
                                            <div class="col-4">
                                                <div class="text-muted small">Vencimento</div>
                                                <div class="fw-bold text-truncate" id="simOpcaoVencimento" style="font-size: 0.9rem;">-</div>
                                            </div>
                                            <div class="col-4">
                                                <div class="text-muted small">Strike</div>
                                                <div class="fw-bold text-truncate" id="simOpcaoStrike" style="font-size: 1.5rem;">-</div>
                                            </div>
                                            <div class="col-4">
                                                <div class="text-muted small">Prêmio</div>
                                                <div class="fw-bold text-success" id="simOpcaoPremio" style="font-size: 0.9rem;">-</div>
                                            </div>
                                            <div class="col-4">
                                                <div class="text-muted small">Dias</div>
                                                <div class="fw-bold text-truncate" id="simOpcaoDias" style="font-size: 0.9rem;">-</div>
                                            </div>
                                            <div class="col-4">
                                                <div class="text-muted small">Distância</div>
                                                <div class="fw-bold text-truncate" id="simOpcaoDistancia" style="font-size: 0.9rem;">-</div>
                                            </div>
                                        </div>
                                        <hr class="my-2">
                                        <!-- Linha com Notional, Saldo e Margem -->
                                        <div class="row g-2">
                                            <div class="col-4">
                                                <div class="text-muted small">Notional</div>
                                                <div class="fw-bold text-truncate" id="simOpcaoNotional" style="font-size: 0.9rem;">-</div>
                                            </div>
                                            <div class="col-4">
                                                <div class="text-muted small">Saldo Corretora</div>
                                                <div class="fw-bold text-truncate text-primary" id="simOpcaoSaldo" style="font-size: 0.9rem;">-</div>
                                            </div>
                                            <div class="col-4">
                                                <div class="text-muted small">Margem (Saldo - Notional)</div>
                                                <div class="fw-bold text-truncate" id="simOpcaoMargem" style="font-size: 0.9rem;">-</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-3 flex-fill">
                                    <div class="col-md-6">
                                        <div class="card h-100">
                                            <div class="card-body text-center d-flex flex-column justify-content-center">
                                                <div class="card-title">Evolução do Patrimônio</div>
                                                <div style="position: relative; height: 120px; width: 100%; display: flex; justify-content: center;">
                                                    <canvas id="chartSimEvolucao"></canvas>
                                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; font-size: 1.2rem;" id="simEvolucaoLabel">18%</div>
                                                </div>
                                                <div class="mt-2 text-success fw-bold" id="simEvolucaoText">Crescimento +18%</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card h-100">
                                            <div class="card-body text-center d-flex flex-column justify-content-center">
                                                <div class="card-title">Lucro ao Fechar</div>
                                                <div style="height: 120px;">
                                                    <canvas id="chartSimLucro"></canvas>
                                                </div>
                                                <div class="mt-2 text-success fw-bold" id="simLucroTotal">Ganho Total: R$ 2.340</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                             <div id="simEmptyState" class="text-center py-5 flex-column justify-content-center flex-fill" style="display: flex;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="text-muted mx-auto mb-3"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                                <p class="text-muted lead">Selecione uma opção na lista ao lado<br>para visualizar a simulação.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-success" id="btnAplicarSimulacao" disabled>Aplicar Simulação</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Modal Detalhe Opcao -->
    <div id="modalDetalheOpcaoContainer"></div>

    <script src="../js/core/libs.js?v=1.0.7"></script>
    <script src="../js/core/global.js?v=1.0.7"></script>
    <script src="../js/core/layout.js?v=1.0.7"></script>
    <script src="../js/technical-analysis.js?v=1.0.7"></script>
    <script src="../js/opcoes.js?v=1.0.7"></script>
    <script src="../js/detalhe-opcoes.js?v=1.0.7"></script>
    <script>
        // Carregar modal de detalhes
        fetch('detalhe-opcoes.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('modalDetalheOpcaoContainer').innerHTML = html;
            })
            .catch(error => console.error('Erro ao carregar modal:', error));
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ideia 5 â€“ Modal Saldo MÃ©dio: Glass Minimal</title>
    <link href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.44.0/tabler-icons.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:'Inter',sans-serif; 
            background:#070b14;
            color:#f0f6ff; font-size:14px;
            min-height:100vh;
        }

        /* ===== ANIMATED BACKGROUND ===== */
        .bg-orbs { position:fixed; inset:0; pointer-events:none; overflow:hidden; }
        .orb {
            position:absolute; border-radius:50%;
            filter:blur(100px); opacity:.12; animation:drift 15s infinite ease-in-out;
        }
        .orb1 { width:600px; height:600px; background:#6366f1; top:-200px; left:-100px; animation-delay:0s; }
        .orb2 { width:500px; height:500px; background:#0ea5e9; bottom:-150px; right:-100px; animation-delay:-5s; }
        .orb3 { width:400px; height:400px; background:#10b981; top:40%; left:50%; animation-delay:-10s; }
        @keyframes drift { 0%,100%{transform:rotate(0deg) scale(1);} 33%{transform:rotate(120deg) scale(1.08);} 66%{transform:rotate(240deg) scale(.96);} }

        /* ===== TRIGGER ===== */
        .page { display:flex; align-items:center; justify-content:center; min-height:100vh; position:relative; }
        .trigger-pill {
            background:rgba(255,255,255,.04); backdrop-filter:blur(20px);
            border:1px solid rgba(255,255,255,.1); border-radius:20px;
            padding:1.5rem 2.5rem; cursor:pointer; text-align:center;
            transition:all .3s ease;
            box-shadow:0 8px 32px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.08);
        }
        .trigger-pill:hover {
            border-color:rgba(99,102,241,.5);
            box-shadow:0 20px 60px rgba(99,102,241,.2), inset 0 1px 0 rgba(255,255,255,.12);
            transform:translateY(-3px);
        }

        /* ===== OVERLAY ===== */
        .overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:9000; align-items:flex-start; justify-content:center; padding:2rem 1rem; overflow-y:auto; backdrop-filter:blur(20px); }
        .overlay.show { display:flex; }

        /* ===== MODAL ===== */
        .modal {
            width:100%; max-width:1180px;
            background:rgba(10,15,30,.85); backdrop-filter:blur(40px);
            border:1px solid rgba(255,255,255,.08); border-radius:28px;
            box-shadow:0 60px 120px rgba(0,0,0,.7), inset 0 1px 0 rgba(255,255,255,.06);
            animation:glassIn .4s cubic-bezier(.22,1,.36,1);
            overflow:hidden;
        }
        @keyframes glassIn { from{opacity:0;transform:translateY(30px) scale(.97);} to{opacity:1;transform:translateY(0) scale(1);} }

        /* ===== GRADIENT STRIP ===== */
        .gradient-strip { height:3px; background:linear-gradient(90deg,#6366f1,#0ea5e9,#10b981,#6366f1); background-size:200%; animation:shimmer 4s linear infinite; }
        @keyframes shimmer { from{background-position:200%} to{background-position:-200%} }

        /* ===== HEADER ===== */
        .mheader { padding:2rem 2.5rem 1.5rem; position:relative; }
        .mheader-row { display:flex; align-items:flex-start; justify-content:space-between; }
        .btn-close {
            background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1);
            color:rgba(255,255,255,.5); width:40px;height:40px; border-radius:12px;
            cursor:pointer; display:flex;align-items:center;justify-content:center;
            transition:all .2s; flex-shrink:0; margin-top:4px;
        }
        .btn-close:hover { background:rgba(239,68,68,.2); border-color:#ef4444; color:#ef4444; }
        .mheader-eyebrow { font-size:.72rem; font-weight:600; letter-spacing:1.5px; text-transform:uppercase; color:rgba(99,102,241,.8); margin-bottom:.5rem; }
        .mheader-amount { font-size:3.5rem; font-weight:900; letter-spacing:-2px; line-height:1; }
        .amt-pos { background:linear-gradient(135deg,#10b981,#34d399); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .amt-neg { background:linear-gradient(135deg,#ef4444,#f87171); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .mheader-pct { font-size:1.1rem; font-weight:600; color:#6b7280; margin-left:1rem; }
        .mheader-sub { font-size:.88rem; color:rgba(255,255,255,.35); margin-top:.4rem; }

        /* ===== PILLS ROW ===== */
        .pills-row { display:flex; gap:.625rem; margin-top:1.25rem; flex-wrap:wrap; }
        .pill {
            padding:5px 14px; border-radius:20px; font-size:.75rem; font-weight:600;
            background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08);
            display:inline-flex; align-items:center; gap:6px;
        }
        .pill.green { background:rgba(16,185,129,.1); border-color:rgba(16,185,129,.25); color:#34d399; }
        .pill.blue  { background:rgba(14,165,233,.1); border-color:rgba(14,165,233,.25); color:#38bdf8; }
        .pill.purple{ background:rgba(99,102,241,.1); border-color:rgba(99,102,241,.25); color:#818cf8; }
        .pill.amber { background:rgba(245,158,11,.1); border-color:rgba(245,158,11,.25); color:#fbbf24; }

        /* ===== DIVIDER ===== */
        .div { height:1px; background:rgba(255,255,255,.05); margin:0 2.5rem; }

        /* ===== CONTENT ===== */
        .mcontent { padding:1.5rem 2.5rem 2.5rem; }

        /* ===== BIG NUMBERS ROW ===== */
        .bignums { display:grid; grid-template-columns:repeat(4,1fr); gap:1px; background:rgba(255,255,255,.05); border-radius:16px; overflow:hidden; margin-bottom:1.5rem; border:1px solid rgba(255,255,255,.06); }
        .bignum-cell {
            background:rgba(10,15,30,.6); padding:1.5rem 1.25rem;
            text-align:center; transition:all .2s;
        }
        .bignum-cell:hover { background:rgba(255,255,255,.03); }
        .bignum-val { font-size:1.8rem; font-weight:800; letter-spacing:-.5px; }
        .bignum-lbl { font-size:.68rem; font-weight:500; text-transform:uppercase; letter-spacing:.5px; color:rgba(255,255,255,.3); margin-top:.3rem; }
        .bignum-sub { font-size:.72rem; color:rgba(255,255,255,.2); margin-top:.2rem; }

        /* ===== TWO-COL ===== */
        .two-col { display:grid; grid-template-columns:1.8fr 1fr; gap:1.5rem; margin-bottom:1.5rem; }
        @media(max-width:800px){.two-col,.bignums{grid-template-columns:1fr 1fr;}}

        /* ===== GLASS BOX ===== */
        .gbox {
            background:rgba(255,255,255,.03); backdrop-filter:blur(10px);
            border:1px solid rgba(255,255,255,.06); border-radius:18px;
            overflow:hidden; transition:border-color .2s;
        }
        .gbox:hover { border-color:rgba(255,255,255,.1); }
        .gbox-hdr {
            padding:1rem 1.25rem; border-bottom:1px solid rgba(255,255,255,.05);
            font-size:.72rem; font-weight:600; text-transform:uppercase; letter-spacing:.5px; color:rgba(255,255,255,.25);
            display:flex; align-items:center; gap:.5rem;
        }
        .gbox-body { padding:1.25rem; }

        /* ===== PoP VISUAL ===== */
        .pop-visual { display:flex; flex-direction:column; align-items:center; gap:1rem; }
        .pop-big { text-align:center; }
        .pop-big-num { font-size:3rem; font-weight:900; letter-spacing:-1px; }
        .pop-big-lbl { font-size:.68rem; text-transform:uppercase; letter-spacing:1px; color:rgba(255,255,255,.3); }
        .pop-sparkles { display:flex; gap:.5rem; justify-content:center; flex-wrap:wrap; }
        .pop-chip { padding:4px 12px; border-radius:10px; font-size:.72rem; font-weight:600; }
        .pchi-good { background:rgba(16,185,129,.12); border:1px solid rgba(16,185,129,.2); color:#34d399; }
        .pchi-med  { background:rgba(245,158,11,.12);  border:1px solid rgba(245,158,11,.2);  color:#fbbf24; }
        .pchi-bad  { background:rgba(239,68,68,.12);   border:1px solid rgba(239,68,68,.2);   color:#f87171; }

        /* ===== OP STRIP ===== */
        .op-strip { display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:.875rem; margin-bottom:1.5rem; }
        .op-glass {
            background:rgba(255,255,255,.025); border:1px solid rgba(255,255,255,.06);
            border-radius:14px; padding:1.25rem; transition:all .25s;
            position:relative; overflow:hidden;
        }
        .op-glass::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; border-radius:2px; }
        .op-glass.vvenc::before { background:linear-gradient(90deg,#10b981,#34d399); }
        .op-glass.loss::before  { background:linear-gradient(90deg,#ef4444,#f87171); }
        .op-glass.open::before  { background:linear-gradient(90deg,#f59e0b,#fbbf24); animation:shimmer 3s linear infinite; background-size:200%; }
        .op-glass:hover { border-color:rgba(255,255,255,.12); transform:translateY(-2px); box-shadow:0 10px 30px rgba(0,0,0,.3); }
        .op-gl-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:.875rem; }
        .op-gl-ticker { font-weight:700; font-size:.95rem; color:#f0f6ff; }
        .op-gl-base { font-size:.7rem; color:rgba(255,255,255,.3); }
        .op-gl-res { font-size:1.1rem; font-weight:800; }
        .op-gl-mid { display:flex; gap:.5rem; flex-wrap:wrap; margin-bottom:.75rem; }
        .op-mini-tag { font-size:.65rem; font-weight:600; padding:2px 8px; border-radius:6px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08); }
        .op-gl-bot { display:flex; align-items:center; gap:.5rem; }
        .op-premio-pct { font-size:.8rem; color:#34d399; font-weight:600; }
        .op-pop-dot { width:6px; height:6px; border-radius:50%; flex-shrink:0; }
        .op-pop-val { font-size:.75rem; font-weight:600; }

        /* ===== PROGRESS ===== */
        .prog-wrap { background:rgba(255,255,255,.05); border-radius:100px; height:6px; overflow:hidden; }
        .prog-fill { height:100%; border-radius:100px; }

        /* FILTER TABS */
        .ftabs { display:flex; gap:.4rem; margin-bottom:1rem; }
        .ftab { padding:5px 14px; border-radius:8px; font-size:.74rem; font-weight:500; border:1px solid rgba(255,255,255,.08); background:transparent; color:rgba(255,255,255,.35); cursor:pointer; transition:all .15s; }
        .ftab:hover { color:rgba(255,255,255,.7); border-color:rgba(255,255,255,.15); }
        .ftab.active { background:rgba(99,102,241,.15); border-color:rgba(99,102,241,.35); color:#818cf8; }
    </style>
</head>
<body>

<div class="bg-orbs">
    <div class="orb orb1"></div>
    <div class="orb orb2"></div>
    <div class="orb orb3"></div>
</div>

<div class="page">
    <div style="text-align:center; position:relative; z-index:1;">
        <p style="color:rgba(255,255,255,.2);font-size:.8rem;margin-bottom:1.5rem;">â†“ Clique no card para abrir o modal</p>
        <div class="trigger-pill" onclick="openM()">
            <div style="font-size:.65rem;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:rgba(99,102,241,.7);margin-bottom:.5rem;">Saldo MÃ©dio</div>
            <div style="font-size:2.5rem;font-weight:900;letter-spacing:-1px;background:linear-gradient(135deg,#10b981,#34d399);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">+3.42%</div>
            <div style="font-size:.8rem;color:rgba(255,255,255,.3);margin-top:.4rem;">R$ 4.280 em prÃªmios Â· 15 operaÃ§Ãµes</div>
            <div style="font-size:.72rem;color:rgba(99,102,241,.6);margin-top:1rem;font-weight:600;">Abrir anÃ¡lise completa â†’</div>
        </div>
        <p style="color:rgba(255,255,255,.15);font-size:.72rem;margin-top:1rem;">Ideia 5 â€” Glass Minimal</p>
    </div>
</div>

<div class="overlay" id="overlay" onclick="closeOvl(event)">
<div class="modal" id="modal">

    <div class="gradient-strip"></div>

    <!-- HEADER -->
    <div class="mheader">
        <div class="mheader-row">
            <div>
                <div class="mheader-eyebrow">âš¡ Saldo MÃ©dio Â· AnÃ¡lise de OperaÃ§Ãµes</div>
                <div style="display:flex;align-items:baseline;gap:.5rem;">
                    <div class="mheader-amount" id="mAmount"><span class="amt-pos">+R$ 4.280</span></div>
                    <div class="mheader-pct" id="mPct">+3.42%</div>
                </div>
                <div class="mheader-sub" id="mSub">sobre saldo inicial de R$ 125.000,00</div>
            </div>
            <button class="btn-close" onclick="closeM()"><i class="ti ti-x" style="font-size:1rem;"></i></button>
        </div>
        <div class="pills-row" id="pillsRow"></div>
    </div>

    <div class="div"></div>

    <div class="mcontent">

        <!-- BIG NUMBERS -->
        <div class="bignums" id="bignums"></div>

        <!-- EVOLUTION + PoP -->
        <div class="two-col">
            <div class="gbox">
                <div class="gbox-hdr"><i class="ti ti-chart-area-line" style="color:#6366f1;"></i> EvoluÃ§Ã£o do Capital</div>
                <div class="gbox-body" style="padding:.75rem;">
                    <div id="chartEvol"></div>
                </div>
            </div>
            <div class="gbox">
                <div class="gbox-hdr"><i class="ti ti-target" style="color:#10b981;"></i> PoP MÃ©dio</div>
                <div class="gbox-body">
                    <div class="pop-visual">
                        <div class="pop-big">
                            <div id="popBigNum" class="pop-big-num" style="background:linear-gradient(135deg,#10b981,#6366f1);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">76%</div>
                            <div class="pop-big-lbl">Probabilidade de Profit</div>
                        </div>
                        <div id="popRingChart"></div>
                        <div class="pop-sparkles" id="popSparkles"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- OP CARDS -->
        <div style="margin-bottom:1rem;">
            <div style="display:flex;align-items:center;gap:.875rem;margin-bottom:1rem;">
                <span style="font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:rgba(255,255,255,.25);">OperaÃ§Ãµes</span>
                <div class="ftabs">
                    <button class="ftab active" onclick="filterCard('all',this)">Todas</button>
                    <button class="ftab" onclick="filterCard('ABERTA',this)">Abertas</button>
                    <button class="ftab" onclick="filterCard('FECHADA',this)">Fechadas</button>
                    <button class="ftab" onclick="filterCard('CALL',this)">CALL</button>
                    <button class="ftab" onclick="filterCard('PUT',this)">PUT</button>
                </div>
            </div>
            <div class="op-strip" id="opStrip"></div>
        </div>

        <!-- BOTTOM: Dois grÃ¡ficos -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;">
            <div class="gbox">
                <div class="gbox-hdr"><i class="ti ti-chart-donut" style="color:#0ea5e9;"></i> Resultado por Tipo</div>
                <div class="gbox-body" style="padding:.75rem;"><div id="chartDonut"></div></div>
            </div>
            <div class="gbox">
                <div class="gbox-hdr"><i class="ti ti-chart-bar" style="color:#f59e0b;"></i> PrÃªmio por Ativo Base</div>
                <div class="gbox-body" style="padding:.75rem;"><div id="chartBar"></div></div>
            </div>
        </div>

    </div>
</div>
</div>

<script>
const OPS=[
    {id:1, ativo_base:'PETR4',ativo:'PETRN369W1',tipo:'CALL',premio:365, resultado:353, saldo_abertura:125000,status:'FECHADA',data_operacao:'2025-12-10',dias:38,strike:36.90},
    {id:2, ativo_base:'PETR4',ativo:'PETRN380W1',tipo:'PUT', premio:280, resultado:275, saldo_abertura:125353,status:'FECHADA',data_operacao:'2025-12-12',dias:36,strike:38.00},
    {id:3, ativo_base:'VALE3',ativo:'VALEB550W1',tipo:'PUT', premio:210, resultado:180, saldo_abertura:125628,status:'FECHADA',data_operacao:'2026-01-05',dias:47,strike:55.00},
    {id:4, ativo_base:'ITUB4',ativo:'ITUBL330W1',tipo:'CALL',premio:220, resultado:218, saldo_abertura:125808,status:'FECHADA',data_operacao:'2026-01-07',dias:10,strike:33.00},
    {id:5, ativo_base:'PETR4',ativo:'PETRF370W1',tipo:'CALL',premio:290, resultado:280, saldo_abertura:126026,status:'FECHADA',data_operacao:'2026-01-10',dias:42,strike:37.00},
    {id:6, ativo_base:'BBDC4',ativo:'BBDCB180W1',tipo:'PUT', premio:180, resultado:-170,saldo_abertura:126306,status:'FECHADA',data_operacao:'2026-01-12',dias:40,strike:18.00},
    {id:7, ativo_base:'VALE3',ativo:'VALEF500W1',tipo:'PUT', premio:280, resultado:268, saldo_abertura:126136,status:'FECHADA',data_operacao:'2026-01-15',dias:37,strike:50.00},
    {id:8, ativo_base:'PETR4',ativo:'PETRN380W2',tipo:'CALL',premio:320, resultado:312, saldo_abertura:126404,status:'FECHADA',data_operacao:'2026-01-20',dias:32,strike:38.00},
    {id:9, ativo_base:'ITUB4',ativo:'ITUBN320W1',tipo:'CALL',premio:190, resultado:189, saldo_abertura:126716,status:'FECHADA',data_operacao:'2026-01-22',dias:30,strike:32.00},
    {id:10,ativo_base:'BBAS3',ativo:'BBASF280W1',tipo:'PUT', premio:260, resultado:-240,saldo_abertura:126905,status:'FECHADA',data_operacao:'2026-01-25',dias:27,strike:28.00},
    {id:11,ativo_base:'PETR4',ativo:'PETRN390G1',tipo:'CALL',premio:250, resultado:245, saldo_abertura:126665,status:'FECHADA',data_operacao:'2026-02-01',dias:47,strike:39.00},
    {id:12,ativo_base:'VALE3',ativo:'VALEF520W1',tipo:'PUT', premio:240, resultado:228, saldo_abertura:126910,status:'FECHADA',data_operacao:'2026-02-03',dias:45,strike:52.00},
    {id:13,ativo_base:'ITUB4',ativo:'ITUBG340W1',tipo:'CALL',premio:170, resultado:164, saldo_abertura:127138,status:'ABERTA', data_operacao:'2026-02-05',dias:43,strike:34.00},
    {id:14,ativo_base:'PETR4',ativo:'PETRG400W1',tipo:'CALL',premio:210, resultado:90,  saldo_abertura:127302,status:'ABERTA', data_operacao:'2026-02-10',dias:38,strike:40.00},
    {id:15,ativo_base:'BBDC4',ativo:'BBDCG200W1',tipo:'PUT', premio:195, resultado:183, saldo_abertura:127392,status:'FECHADA',data_operacao:'2026-02-12',dias:36,strike:20.00},
];
const POP_MAP={1:82,2:78,3:74,4:88,5:79,6:58,7:76,8:81,9:86,10:55,11:83,12:77,13:85,14:72,15:80};

const fmt  = v => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v);
const fmtK = v => 'R$'+(v/1000).toFixed(1)+'k';

let evoChart=null,donutChart=null,barChart=null,popRingC=null;

function openM() { document.getElementById('overlay').classList.add('show'); render(); }
function closeM(){ document.getElementById('overlay').classList.remove('show'); }
function closeOvl(e){ if(e.target===document.getElementById('overlay')) closeM(); }

function render(){
    const sorted=[...OPS].sort((a,b)=>new Date(a.data_operacao)-new Date(b.data_operacao));
    const tPremio=OPS.reduce((a,o)=>a+(o.premio||0),0);
    const tResult=OPS.reduce((a,o)=>a+(o.resultado||0),0);
    const fechadas=OPS.filter(o=>o.status==='FECHADA');
    const venc=fechadas.filter(o=>(o.resultado||0)>0);
    const abertas=OPS.filter(o=>o.status==='ABERTA');
    const saldoIni=OPS[0].saldo_abertura;
    const saldoAtual=saldoIni+tResult;
    const winRate=fechadas.length? venc.length/fechadas.length*100: 0;
    const popMedio=OPS.reduce((a,o)=>a+(POP_MAP[o.id]||70),0)/OPS.length;
    const durMedia=OPS.reduce((a,o)=>a+(o.dias||30),0)/OPS.length;
    const pctResult=tResult/saldoIni*100;
    const pctPremio=tPremio/saldoIni*100;

    // Header
    const sign=tResult>=0?'+':'';
    document.getElementById('mAmount').innerHTML=`<span class="${tResult>=0?'amt-pos':'amt-neg'}">${sign}${fmt(tResult)}</span>`;
    document.getElementById('mPct').textContent=sign+pctResult.toFixed(2)+'%';
    document.getElementById('mSub').textContent=`sobre saldo inicial de ${fmt(saldoIni)}`;

    // Pills
    const pills=[
        {cls:'green',icon:'âœ…',txt:venc.length+' vencedoras'},
        {cls:'blue', icon:'ðŸ“Š',txt:'PoP '+popMedio.toFixed(0)+'%'},
        {cls:'purple',icon:'â±',txt:durMedia.toFixed(0)+'d mÃ©dio'},
        {cls:'amber',icon:'ðŸ”“',txt:abertas.length+' aberta'+( abertas.length!==1?'s':'')},
    ];
    document.getElementById('pillsRow').innerHTML=pills.map(p=>`<div class="pill ${p.cls}">${p.icon} ${p.txt}</div>`).join('');

    // Big numbers
    const bns=[
        {val:fmt(tPremio),lbl:'PrÃªmio Total',sub:'+'+pctPremio.toFixed(2)+'% s/ saldo',col:'#34d399'},
        {val:winRate.toFixed(0)+'%',lbl:'Win Rate',sub:venc.length+' de '+fechadas.length+' ops',col:'#38bdf8'},
        {val:popMedio.toFixed(1)+'%',lbl:'PoP MÃ©dio',sub:'Prob. de Profit',col:'#818cf8'},
        {val:durMedia.toFixed(0)+' dias',lbl:'DuraÃ§Ã£o MÃ©dia',sub:'por operaÃ§Ã£o',col:'#fbbf24'},
    ];
    document.getElementById('bignums').innerHTML=bns.map(b=>`<div class="bignum-cell"><div class="bignum-val" style="color:${b.col}">${b.val}</div><div class="bignum-lbl">${b.lbl}</div><div class="bignum-sub">${b.sub}</div></div>`).join('');

    // PoP
    document.getElementById('popBigNum').textContent=popMedio.toFixed(0)+'%';
    const popGood=OPS.filter(o=>POP_MAP[o.id]>=75).length;
    const popMed=OPS.filter(o=>POP_MAP[o.id]>=60&&POP_MAP[o.id]<75).length;
    const popBad=OPS.filter(o=>POP_MAP[o.id]<60).length;
    document.getElementById('popSparkles').innerHTML=`
        <span class="pop-chip pchi-good">â‰¥75%: ${popGood} ops</span>
        <span class="pop-chip pchi-med">60â€“74%: ${popMed} ops</span>
        <span class="pop-chip pchi-bad">&lt;60%: ${popBad} ops</span>
    `;

    if(popRingC){popRingC.destroy();}
    popRingC=new ApexCharts(document.getElementById('popRingChart'),{
        series:[+popMedio.toFixed(1), +winRate.toFixed(1)],
        labels:['PoP Esperado','Win Rate Real'],
        chart:{type:'radialBar',height:200,background:'transparent',toolbar:{show:false}},
        plotOptions:{radialBar:{hollow:{size:'30%'},track:{background:'rgba(255,255,255,.05)'},dataLabels:{total:{show:true,fontSize:'1rem',fontWeight:700,color:'rgba(255,255,255,.5)',formatter:()=>popMedio.toFixed(0)+'%'},value:{fontSize:'1rem',color:'#f0f6ff',fontWeight:700}}}},
        colors:['#10b981','#6366f1'],
        fill:{type:'gradient',gradient:{shade:'dark',type:'circular',stops:[0,80,100]}},
        legend:{labels:{colors:'rgba(255,255,255,.4)'},fontSize:'11px'},
        tooltip:{theme:'dark'},
    });
    popRingC.render();

    // Evolution chart
    let bal=sorted[0].saldo_abertura;
    const cats=['InÃ­cio'],bals=[bal],prems=[0]; let pa=0;
    sorted.forEach(o=>{ cats.push(o.ativo.slice(0,6)); pa+=o.premio||0; bal+=o.resultado||0; bals.push(bal); prems.push(pa); });
    if(evoChart){evoChart.destroy();}
    evoChart=new ApexCharts(document.getElementById('chartEvol'),{
        series:[{name:'Capital',data:bals,type:'area'},{name:'PrÃªmios',data:prems,type:'line'}],
        chart:{type:'line',height:220,background:'transparent',toolbar:{show:false},animations:{speed:600}},
        stroke:{width:[2.5,1.5],curve:'smooth',dashArray:[0,4]},
        fill:{type:['gradient','solid'],gradient:{shadeIntensity:.8,opacityFrom:.35,opacityTo:.03,stops:[0,100]}},
        colors:['#10b981','#6366f1'],
        xaxis:{categories:cats,labels:{style:{colors:Array(cats.length).fill('rgba(255,255,255,.2)'),fontSize:'9px'}},axisBorder:{show:false},axisTicks:{show:false}},
        yaxis:{labels:{formatter:v=>fmtK(v),style:{colors:['rgba(255,255,255,.25)']}}},
        grid:{borderColor:'rgba(255,255,255,.04)',strokeDashArray:4},
        legend:{labels:{colors:'rgba(255,255,255,.35)'}},
        tooltip:{theme:'dark',y:{formatter:v=>fmt(v)}},
    });
    evoChart.render();

    // Op cards
    renderCards(OPS, 'all');

    // Donut
    const callR=OPS.filter(o=>o.tipo==='CALL').reduce((a,o)=>a+(o.resultado||0),0);
    const putR=OPS.filter(o=>o.tipo==='PUT').reduce((a,o)=>a+(o.resultado||0),0);
    if(donutChart){donutChart.destroy();}
    donutChart=new ApexCharts(document.getElementById('chartDonut'),{
        series:[Math.max(callR,0),Math.max(putR,0)],
        labels:['CALL','PUT'],
        chart:{type:'donut',height:220,background:'transparent'},
        colors:['#6366f1','#0ea5e9'],
        fill:{type:'gradient'},
        legend:{labels:{colors:'rgba(255,255,255,.4)'},position:'bottom'},
        plotOptions:{pie:{donut:{size:'65%',labels:{show:true,total:{show:true,label:'Total',color:'rgba(255,255,255,.3)',formatter:()=>fmt(callR+putR)}}}}},
        tooltip:{theme:'dark',y:{formatter:v=>fmt(v)}},
    });
    donutChart.render();

    // Bar
    const mp={};
    OPS.forEach(o=>{mp[o.ativo_base]=(mp[o.ativo_base]||0)+(o.resultado||0);});
    if(barChart){barChart.destroy();}
    barChart=new ApexCharts(document.getElementById('chartBar'),{
        series:[{name:'Resultado',data:Object.values(mp)}],
        chart:{type:'bar',height:220,background:'transparent',toolbar:{show:false}},
        plotOptions:{bar:{horizontal:true,borderRadius:6,distributed:true}},
        colors:Object.values(mp).map(v=>v>=0?'#10b981':'#ef4444'),
        xaxis:{categories:Object.keys(mp),labels:{style:{colors:Array(Object.keys(mp).length).fill('rgba(255,255,255,.25)'),fontSize:'11px'}}},
        yaxis:{labels:{style:{colors:['rgba(255,255,255,.25)']}}},
        grid:{borderColor:'rgba(255,255,255,.04)'},
        legend:{show:false},
        tooltip:{theme:'dark',y:{formatter:v=>fmt(v)}},
    });
    barChart.render();
}

function filterCard(f, btn) {
    document.querySelectorAll('.ftab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    renderCards(OPS, f);
}

function renderCards(ops, f) {
    let filtered=ops;
    if(f==='ABERTA'||f==='FECHADA') filtered=ops.filter(o=>o.status===f);
    if(f==='CALL'||f==='PUT') filtered=ops.filter(o=>o.tipo===f);
    const strip=document.getElementById('opStrip');
    strip.innerHTML='';
    filtered.forEach(op=>{
        const pop=POP_MAP[op.id]||70;
        const res=op.resultado||0;
        const pct=(op.premio/(op.saldo_abertura||125000)*100).toFixed(2);
        const cls=op.status==='ABERTA'?'open':res>=0?'vvenc':'loss';
        const resColor=res>=0?'#34d399':'#f87171';
        const popColor=pop>=75?'#34d399':pop>=60?'#fbbf24':'#f87171';
        const tipoCls=op.tipo==='CALL'?'color:#818cf8;border-color:rgba(129,140,248,.3);':'color:#38bdf8;border-color:rgba(56,189,248,.3);';
        const div=document.createElement('div');
        div.className=`op-glass ${cls}`;
        div.innerHTML=`
            <div class="op-gl-top">
                <div>
                    <div class="op-gl-ticker">${op.ativo}</div>
                    <div class="op-gl-base">${op.ativo_base} Â· Strike R$${op.strike.toFixed(2)}</div>
                </div>
                <div class="op-gl-res" style="color:${resColor}">${fmt(res)}</div>
            </div>
            <div class="op-gl-mid">
                <span class="op-mini-tag" style="${tipoCls}">${op.tipo}</span>
                <span class="op-mini-tag">${op.dias}d</span>
                <span class="op-mini-tag" style="color:${op.status==='ABERTA'?'#fbbf24':'#34d399'}">${op.status}</span>
            </div>
            <div class="op-gl-bot">
                <span class="op-premio-pct">${fmt(op.premio)} (${pct}%)</span>
                <span style="flex:1;"></span>
                <span class="op-pop-dot" style="background:${popColor};box-shadow:0 0 6px ${popColor}60;"></span>
                <span class="op-pop-val" style="color:${popColor}">PoP ${pop}%</span>
            </div>
        `;
        strip.appendChild(div);
    });
}
</script>
</body>
</html>
